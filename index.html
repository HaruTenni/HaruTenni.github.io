<!doctype html>
<html lang="ja">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>„ÉÄ„Éº„ÉÑ„ÅÆÊóÖ - JAPAN</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg1: #0ea5e9;
            --bg2: #8b5cf6;
            --glass: rgba(255, 255, 255, .16);
            --glass-strong: rgba(255, 255, 255, .22);
            --border: rgba(255, 255, 255, .35);
            --chip-border: rgba(0, 0, 0, .10);
            --chip-off-bg: #f3f4f6;
            --accent: #22c55e;

            --pin-in: 1.6s;
            --ping: 2.2s;
            --sheet: .70s;
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            font-family: "Noto Sans JP", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
            color: #07111f;
            background:
                radial-gradient(1200px 800px at 10% 10%, rgba(255, 255, 255, .35), transparent 60%),
                radial-gradient(1200px 800px at 90% 90%, rgba(255, 255, 255, .28), transparent 60%),
                linear-gradient(135deg, var(--bg1), var(--bg2));
            overflow: hidden;
        }

        .app {
            display: grid;
            grid-template-columns: 360px 1fr;
            gap: 18px;
            height: 100%;
            padding: 18px;
        }

        .panel {
            height: 100%;
            backdrop-filter: blur(14px) saturate(120%);
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .18), inset 0 1px 0 rgba(255, 255, 255, .25);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            padding: 18px 18px 10px;
            border-bottom: 1px dashed rgba(255, 255, 255, .35);
        }

        .title {
            font-size: 22px;
            font-weight: 800;
            letter-spacing: .02em;
            color: #fff;
            text-shadow: 0 2px 12px rgba(0, 0, 0, .25);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sparkle {
            width: 20px;
            height: 20px;
            display: inline-block;
            filter: drop-shadow(0 0 6px rgba(255, 255, 255, .8));
            background: radial-gradient(circle at 50% 50%, #fff, #fff0 60%),
                radial-gradient(circle at 75% 25%, #fff, #fff0 50%),
                radial-gradient(circle at 25% 75%, #fff, #fff0 50%);
            mask: conic-gradient(from 0deg, #000 0 10deg, #0000 10deg 20deg) 50% 50%/100% 100% repeat;
            animation: twink 2.4s linear infinite;
        }

        @keyframes twink {
            0% {
                transform: rotate(0deg) scale(1)
            }

            50% {
                transform: rotate(180deg) scale(1.2)
            }

            100% {
                transform: rotate(360deg) scale(1)
            }
        }

        .panel-body {
            padding: 14px 16px 16px;
            overflow: auto
        }

        .chips {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .section-label {
            margin: 12px 0 6px;
            font-weight: 800;
            font-size: 12px;
            letter-spacing: .07em;
            color: #f8fafc;
            text-shadow: 0 1px 8px rgba(0, 0, 0, .25)
        }

        .chip {
            appearance: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            border-radius: 999px;
            background: #fff;
            border: 1px solid var(--chip-border);
            box-shadow: 0 6px 16px rgba(0, 0, 0, .08);
            cursor: pointer;
            user-select: none;
            transition: transform .12s, box-shadow .12s, background .12s, opacity .12s, filter .12s;
        }

        .chip input {
            display: none
        }

        .chip .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #cbd5e1;
            box-shadow: inset 0 0 0 1px rgba(0, 0, 0, .25);
        }

        .chip[data-checked="true"] {
            transform: translateY(-1px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, .12);
            opacity: 1;
            background: #fff;
        }

        .chip[data-checked="false"] {
            background: var(--chip-off-bg);
            opacity: .48;
            filter: saturate(70%);
            box-shadow: 0 4px 10px rgba(0, 0, 0, .06);
        }

        .chip[data-checked="true"] .dot {
            background: var(--accent);
        }

        .actions {
            margin-top: 16px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            appearance: none;
            border: 0;
            cursor: pointer;
            padding: 14px 18px;
            border-radius: 14px;
            font-weight: 700;
            letter-spacing: .02em;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 10px 24px rgba(0, 0, 0, .18), inset 0 1px 0 rgba(255, 255, 255, .6);
            transition: transform .12s, box-shadow .12s, filter .12s;
            color: #0b1020;
        }

        .btn-throw {
            background: linear-gradient(135deg, #fff, #e2f8f0);
            border: 1px solid rgba(0, 0, 0, .08);
        }

        .btn[disabled] {
            opacity: .5;
            cursor: not-allowed;
        }

        .btn:hover:not([disabled]) {
            transform: translateY(-2px);
            box-shadow: 0 16px 28px rgba(0, 0, 0, .2)
        }

        .btn:active:not([disabled]) {
            transform: translateY(0);
            box-shadow: 0 10px 24px rgba(0, 0, 0, .18)
        }

        .hint {
            font-size: 12px;
            opacity: .85;
            margin-left: auto;
            color: #082238;
            backdrop-filter: blur(10px);
            padding: 6px 10px;
            border-radius: 999px;
            background: #ffffffc9;
            border: 1px solid rgba(0, 0, 0, .06)
        }

        .map-wrap {
            position: relative;
            border-radius: 20px;
            overflow: hidden;
            border: 1px solid var(--border);
            box-shadow: 0 10px 30px rgba(0, 0, 0, .2), inset 0 1px 0 rgba(255, 255, 255, .25);
            background: #dce9ff;
            min-height: 60vh;
        }

        #map {
            position: absolute;
            inset: 0
        }

        .leaflet-control-zoom {
            border-radius: 12px;
            overflow: hidden
        }

        .leaflet-control-zoom a {
            font-weight: 800
        }

        /* ‚ñº ÁµêÊûú„Ç∑„Éº„Éà */
        .sheet {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            transform: translateY(110%);
            transition: transform var(--sheet) cubic-bezier(.2, .8, .2, 1);
            padding: 16px;
            pointer-events: none;
            z-index: 1000;
        }

        .sheet-inner {
            pointer-events: auto;
            margin: 0 auto;
            max-width: 900px;
            background: var(--glass-strong);
            border: 1px solid var(--border);
            backdrop-filter: blur(14px) saturate(120%);
            border-radius: 20px;
            padding: 14px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, .25), inset 0 1px 0 rgba(255, 255, 255, .35);
            max-height: 32vh;
            overflow: auto;
        }

        @media (max-width: 1100px) {
            .sheet-inner {
                max-height: 38vh;
            }
        }

        .sheet.show {
            transform: translateY(0)
        }

        .sheet-header {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            padding: 6px 8px 10px;
            border-bottom: 1px dashed rgba(255, 255, 255, .4);
            color: #fff;
            text-shadow: 0 1px 10px rgba(0, 0, 0, .25);
        }

        .pill {
            font-size: 12px;
            font-weight: 800;
            letter-spacing: .06em;
            color: #08384a;
            background: #ffffffd9;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid rgba(0, 0, 0, .08)
        }

        .block-title {
            margin-top: 14px;
            color: #f8fafc;
            font-weight: 800;
            letter-spacing: .04em;
        }

        .spots {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 8px
        }

        .foods {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 8px
        }

        .card {
            background: #ffffffde;
            border: 1px solid rgba(0, 0, 0, .06);
            border-radius: 14px;
            padding: 12px;
            box-shadow: 0 8px 18px rgba(0, 0, 0, .1);
        }

        .card h4 {
            margin: 0 0 6px;
            font-size: 14px
        }

        .card p {
            margin: 0;
            font-size: 12px;
            opacity: .8
        }

        .card a {
            color: #0e7490;
            font-weight: 700;
            text-decoration: none
        }

        .time {
            font-weight: 700;
            opacity: .95;
            margin-top: 6px
        }

        .again {
            background: linear-gradient(135deg, #fffafb, #ffe9bd);
            border: 1px solid rgba(0, 0, 0, .08);
        }

        .decide {
            background: linear-gradient(135deg, #e4f7ff, #d1ffd8);
            border: 1px solid rgba(0, 0, 0, .08);
        }

        .admin {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-left: auto;
        }

        .admin .pill {
            background: #fff;
            color: #063042
        }

        .pin-wrap {
            position: relative;
            width: 60px;
            height: 60px;
            transform-origin: 50% 90%;
            animation: dartIn var(--pin-in) cubic-bezier(.2, .8, .2, 1);
            filter: drop-shadow(0 8px 16px rgba(0, 0, 0, .35));
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }

        .pin-emoji {
            font-size: 56px;
            line-height: 1;
        }

        @keyframes dartIn {
            0% {
                transform: translate(-260px, -260px) rotate(-8deg) scale(.8)
            }

            70% {
                transform: translate(0, 0) rotate(3deg) scale(1.08)
            }

            100% {
                transform: translate(0, 0) rotate(0deg) scale(1)
            }
        }

        .impact {
            position: absolute;
            left: 50%;
            top: 92%;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ef4444aa;
            transform: translate(-50%, -50%);
            animation: ping var(--ping) ease-out forwards;
        }

        @keyframes ping {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, .6)
            }

            100% {
                box-shadow: 0 0 0 26px rgba(239, 68, 68, 0)
            }
        }

        .confetti {
            position: absolute;
            pointer-events: none;
            inset: 0;
            overflow: hidden;
            z-index: 900;
        }

        .confetti i {
            position: absolute;
            width: 8px;
            height: 12px;
            opacity: .9;
            transform: translate(-50%, -50%) rotate(0deg);
            animation: fall 1.8s linear forwards;
        }

        @keyframes fall {
            0% {
                transform: translate(var(--x), var(--y)) rotate(0deg)
            }

            100% {
                transform: translate(calc(var(--x) + (var(--drift))), calc(var(--y) + 280px)) rotate(260deg)
            }
        }

        .nominatim {
            margin-top: 10px;
            font-size: 11px;
            opacity: .7
        }

        .nominatim a {
            color: #0e7490;
            text-decoration: none;
        }

        /* ‚ñº Ë©≥Á¥∞„Ç™„Éº„Éê„Éº„É¨„Ç§Ôºà„É°„Ç§„É≥UI„Å®Áµ±‰∏ÄÔºâ */
        .detail {
            position: fixed;
            inset: 0;
            display: none;
            place-items: center;
            z-index: 2000;
        }

        .detail.show {
            display: grid;
        }

        .detail-card {
            width: min(980px, 92vw);
            max-height: 86vh;
            overflow: auto;
            background: var(--glass-strong);
            border: 1px solid var(--border);
            backdrop-filter: blur(14px) saturate(120%);
            border-radius: 20px;
            box-shadow: 0 30px 60px rgba(0, 0, 0, .35), inset 0 1px 0 rgba(255, 255, 255, .35);
            padding: 16px;
        }

        .detail-head {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            border-bottom: 1px dashed rgba(255, 255, 255, .4);
            padding-bottom: 10px;
            color: #fff;
            text-shadow: 0 1px 10px rgba(0, 0, 0, .25);
        }

        .detail-title {
            font-weight: 800;
            font-size: 18px
        }

        .detail-close {
            margin-left: auto;
            appearance: none;
            border: 0;
            background: linear-gradient(135deg, #fff, #e2f8f0);
            border: 1px solid rgba(0, 0, 0, .08);
            padding: 10px 12px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 800;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 1.2fr .8fr;
            gap: 12px;
            margin-top: 12px
        }

        .detail-box {
            background: #ffffffde;
            border: 1px solid rgba(0, 0, 0, .06);
            border-radius: 14px;
            padding: 12px;
            box-shadow: 0 8px 18px rgba(0, 0, 0, .1);
        }

        .detail-box h4 {
            margin: 0 0 6px;
            font-size: 14px
        }

        .kv {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            font-size: 13px;
        }

        .btn-mini {
            appearance: none;
            border: 1px solid #e5e7eb;
            background: #fff;
            border-radius: 10px;
            padding: 8px 10px;
            font-weight: 700;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: #0b1020
        }

        .btn-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 6px
        }

        .hotel-links a {
            margin-right: 6px
        }

        @media (max-width: 980px) {
            .detail-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 1100px) {
            .app {
                grid-template-columns: 1fr;
                grid-template-rows: 320px 1fr;
            }

            .panel {
                order: 1
            }

            .map-wrap {
                order: 2;
                min-height: 50dvh
            }

            .spots,
            .foods {
                grid-template-columns: 1fr
            }

            .admin {
                width: 100%
            }
        }

        /* ËøΩÂä†ÔºöÂ§©Ê∞ó„Ç´„Éº„ÉâË¶ã„ÅüÁõÆ */
        .wx-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px
        }

        .wx-card {
            background: #fff;
            border: 1px solid rgba(0, 0, 0, .06);
            border-radius: 12px;
            padding: 10px 12px;
            box-shadow: 0 6px 14px rgba(0, 0, 0, .08);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
        }

        .wx-emoji {
            font-size: 18px
        }

        .wx-date {
            font-weight: 800
        }

        .wx-temp {
            font-weight: 700
        }

        .wx-now {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            background: #ffffffde;
            border: 1px solid rgba(0, 0, 0, .06);
            padding: 10px 12px;
            border-radius: 12px;
            box-shadow: 0 6px 14px rgba(0, 0, 0, .08);
            margin-top: 6px
        }
    </style>
</head>

<body>
    <div class="app">
        <aside class="panel">
            <div class="panel-header">
                <div class="title"><span class="sparkle"></span> „ÉÄ„Éº„ÉÑ„ÅÆÊóÖ - JAPAN</div>
            </div>
            <div class="panel-body">
                <div style="font-size:13px; opacity:.9; margin-bottom:8px; color:#04202f;">Ë°å„ÅçÂÖà„Å´„Åó„Åü„ÅÑ„ÄåÂú∞Êñπ„Äç„ÇíÈÅ∏„Çì„Åß„Åã„Çâ„ÄÅ„ÉÄ„Éº„ÉÑ„ÇíÊäï„Åí„Çà„ÅÜÔºÅ
                </div>
                <div class="chips" id="regionChips"></div>

                <div class="section-label">Èõ∞Âõ≤Ê∞ó</div>
                <div class="chips" id="vibeChips"></div>

                <div class="section-label">Á´ãÂú∞</div>
                <div class="chips" id="locChips"></div>

                <div class="actions">
                    <button class="btn btn-throw" id="throwBtn" disabled>üéØ Ë™≠„ÅøËæº„Åø‰∏≠‚Ä¶</button>
                    <span class="hint" id="hint">Âú∞Êñπ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</span>
                </div>
            </div>
        </aside>

        <section class="map-wrap">
            <div id="map"></div>
            <div class="confetti" id="confetti"></div>
            <div class="sheet" id="sheet">
                <div class="sheet-inner">
                    <div class="sheet-header">
                        <span class="pill" id="pickedRegion">‚Äî</span>
                        <div style="color:#fff; font-weight:800; font-size:18px; letter-spacing:.02em;">
                            <span id="pickedPref">‚Äî</span> „ÅÆ„Åä„Åô„Åô„ÇÅ„Çπ„Éù„ÉÉ„Éà
                        </div>
                        <div class="admin" id="adminPath"></div>
                        <div style="display:flex; gap:8px; margin-left:auto">
                            <button class="btn again" id="againBtn">„ÇÇ„ÅÜ‰∏ÄÊäïÔºÅ</button>
                            <button class="btn decide" id="decideBtn">Ë°å„ÅçÂÖàÊ±∫ÂÆöÔºÅ</button>
                        </div>
                    </div>

                    <div class="block-title">Ë¶≥ÂÖâÂú∞</div>
                    <div class="spots" id="spots"></div>

                    <div class="block-title">„ÅîÂΩìÂú∞„Ç∞„É´„É°</div>
                    <div class="foods" id="foods"></div>

                    <div class="nominatim" id="nominatimAttribution" hidden>
                        ‰ΩèÊâÄ/Âú∞Âêç/„É´„Éº„ÉÜ„Ç£„É≥„Ç∞: ¬© <a href="https://www.openstreetmap.org/copyright" target="_blank"
                            rel="noreferrer">OpenStreetMap</a> / <a href="https://nominatim.org/" target="_blank"
                            rel="noreferrer">Nominatim</a> / <a href="http://project-osrm.org/" target="_blank"
                            rel="noreferrer">OSRM</a>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Ë©≥Á¥∞„Éö„Éº„Ç∏Ôºà„Ç™„Éº„Éê„Éº„É¨„Ç§Ôºâ -->
    <div class="detail" id="detail">
        <div class="detail-card">
            <div class="detail-head">
                <div class="detail-title">Ë°å„ÅçÂÖà Ë©≥Á¥∞ÊÉÖÂ†±</div>
                <button class="detail-close" id="detailClose">Èñâ„Åò„Çã</button>
            </div>
            <div class="detail-grid">
                <div class="detail-box">
                    <h4>Êù±‰∫¨ÈßÖ„Åã„Çâ„ÅÆË°å„ÅçÊñπ„ÉªÊâÄË¶ÅÊôÇÈñì</h4>
                    <div class="kv" id="routeInfo">
                        <div>üöó ËªäÔºàÊ¶ÇÁÆóÔºâ: Ë®àÁÆó‰∏≠‚Ä¶</div>
                    </div>
                    <div class="btn-row" id="routeLinks"></div>
                    <div style="font-size:12px; opacity:.7; margin-top:6px">‚Äª Ëªä„ÅÆÊâÄË¶ÅÊôÇÈñì„ÅØOSRM„Éô„Éº„Çπ„ÅÆÊ¶ÇÁÆó„Åß„Åô„ÄÇÂÆüÈöõ„ÅÆ‰∫§ÈÄöÁä∂Ê≥Å„ÅßÂ§âÂãï„Åó„Åæ„Åô„ÄÇ</div>
                </div>
                <div class="detail-box">
                    <h4>Âë®Ëæ∫„ÅÆÂÆøÔºàRakuten Travel / AirbnbÔºâ</h4>
                    <div class="hotel-links" id="hotelLinks"></div>
                    <div style="font-size:12px; opacity:.7; margin-top:6px">‚Äª ÂêÑ„Çµ„Ç§„Éà„ÅÆÊ§úÁ¥¢‰ªïÊßò/‰∏¶„Å≥È†Ü„Å´‰æùÂ≠ò„Åó„Åæ„Åô„ÄÇ</div>
                </div>
            </div>

            <div class="detail-box" style="margin-top:12px">
                <h4>„Ç®„É™„Ç¢ÊÉÖÂ†±</h4>
                <div class="kv" id="areaInfo">ÂèñÂæó‰∏≠‚Ä¶</div>
            </div>

            <div class="detail-box" id="weatherBox" style="margin-top:12px">
                <h4>Â§©Ê∞ó„Å®Ê∞óÂÄôÔºàÁèæÂú®Ôºã3Êó•Ôºâ</h4>
                <div id="weatherNow" class="wx-now">ÂèñÂæó‰∏≠‚Ä¶</div>
                <div id="weatherDaily" class="wx-row"></div>
                <div style="font-size:11px; opacity:.65; margin-top:6px">‚Äª Open‚ÄëMeteo „ÅÆÁÑ°ÊñôAPI„ÇíÂà©Áî®Ôºà„Ç≠„Éº‰∏çË¶ÅÔºâ</div>
            </div>

            <div class="detail-box" id="snsBox" style="margin-top:12px">
                <h4>SNSÔºàInstagram „Éè„ÉÉ„Ç∑„É•„Çø„Ç∞Ôºâ</h4>
                <div class="btn-row" id="snsLinks"></div>
                <div style="font-size:11px; opacity:.65; margin-top:6px">‚Äª „ÇØ„É™„ÉÉ„ÇØ„ÅßInstagram„ÅÆ„Éè„ÉÉ„Ç∑„É•„Çø„Ç∞„Éö„Éº„Ç∏„ÇíÊñ∞Ë¶è„Çø„Éñ„ÅßÈñã„Åç„Åæ„Åô„ÄÇ</div>
            </div>
        </div>
    </div>

    <script>
        /* ====== Ë®≠ÂÆö ====== */
        const CONTACT_EMAIL = "";
        const CACHE_TTL_MS = 7 * 24 * 60 * 60 * 1000;

        /* ===== ÊºîÂá∫„ÉÜ„É≥„Éù ===== */
        const TIMING = {
            flyOutMs: 3000,
            pauseAfterOut: 1000,
            flyToRegionMs: 2800,
            pauseBeforePin: 500,
            pinDropMs: 1600,
            zoomToPrefMs: 3400,
            zoomToPinMs: 3600,
            sheetDelayMs: 750,
            confettiCount: 8
        };

        /* ========= „Éá„Éº„Çø ========= */
        const REGIONS = [
            { id: 'ÂåóÊµ∑ÈÅì', color: '#60a5fa' },
            { id: 'Êù±Âåó', color: '#34d399' },
            { id: 'Èñ¢Êù±', color: '#f59e0b' },
            { id: '‰∏≠ÈÉ®', color: '#a78bfa' },
            { id: 'ËøëÁïø', color: '#f472b6' },
            { id: '‰∏≠ÂõΩ', color: '#22c55e' },
            { id: 'ÂõõÂõΩ', color: '#06b6d4' },
            { id: '‰πùÂ∑û„ÉªÊ≤ñÁ∏Ñ', color: '#fb7185' },
        ];

        const PREFS = [
            P('ÂåóÊµ∑ÈÅì', 'ÂåóÊµ∑ÈÅì', 43.064, 141.346, ['Áü•Â∫äÂçäÂ≥∂', 'Â∞èÊ®ΩÈÅãÊ≤≥', 'Êó≠Â±±ÂãïÁâ©Âúí']),
            P('ÈùíÊ£Æ', 'Êù±Âåó', 40.824, 140.740, ['ÂçÅÂíåÁî∞Êπñ', 'Â••ÂÖ•ÁÄ¨Ê∏ìÊµÅ', '‰∏âÂÜÖ‰∏∏Â±±ÈÅ∫Ë∑°']),
            P('Â≤©Êâã', 'Êù±Âåó', 39.703, 141.152, ['‰∏≠Â∞äÂØ∫', 'ÊµÑÂúü„É∂Êµú', 'Â∞èÂ≤©‰∫ïËæ≤Â†¥']),
            P('ÂÆÆÂüé', 'Êù±Âåó', 38.268, 140.871, ['ÊùæÂ≥∂', '‰ªôÂè∞ÂüéË∑°', 'Áßã‰øùÊ∏©Ê≥â']),
            P('ÁßãÁî∞', 'Êù±Âåó', 39.719, 140.103, ['ËßíÈ§®Ê≠¶ÂÆ∂Â±ãÊï∑', 'Áî∑ÈπøÂçäÂ≥∂', '‰π≥È†≠Ê∏©Ê≥âÈÉ∑']),
            P('Â±±ÂΩ¢', 'Êù±Âåó', 38.255, 140.339, ['Â±±ÂØ∫ÔºàÁ´ãÁü≥ÂØ∫Ôºâ', 'ÈäÄÂ±±Ê∏©Ê≥â', 'ËîµÁéã„É≠„Éº„Éó„Ç¶„Çß„Ç§']),
            P('Á¶èÂ≥∂', 'Êù±Âåó', 37.750, 140.467, ['Â§ßÂÜÖÂÆø', '‰∫îËâ≤Ê≤º', 'È∂¥„É∂Âüé']),
            P('Ëå®Âüé', 'Èñ¢Êù±', 36.341, 140.446, ['ÂõΩÂñ∂„Å≤„Åü„Å°Êµ∑ÊµúÂÖ¨Âúí', 'Ë¢ãÁî∞„ÅÆÊªù', 'ÂÅïÊ•ΩÂúí']),
            P('Ê†ÉÊú®', 'Èñ¢Êù±', 36.565, 139.883, ['Êó•ÂÖâÊù±ÁÖßÂÆÆ', 'ËèØÂé≥„ÅÆÊªù', 'ÈÇ£È†àÈ´òÂéü']),
            P('Áæ§È¶¨', 'Èñ¢Êù±', 36.391, 139.060, ['ËçâÊ¥•Ê∏©Ê≥â', '‰ºäÈ¶ô‰øùÊ∏©Ê≥â', 'Ë∞∑Â∑ùÂ≤≥']),
            P('ÂüºÁéâ', 'Èñ¢Êù±', 35.861, 139.645, ['Â∑ùË∂äËîµÈÄ†„Çä„ÅÆÁî∫‰∏¶„Åø', 'Áß©Áà∂Á•ûÁ§æ', 'ÈâÑÈÅìÂçöÁâ©È§®']),
            P('ÂçÉËëâ', 'Èñ¢Êù±', 35.607, 140.106, ['ÊàêÁî∞Â±±Êñ∞ÂãùÂØ∫', 'ÂçóÊàøÁ∑è', 'Êù±‰∫¨„Éá„Ç£„Ç∫„Éã„Éº„É™„Çæ„Éº„Éà']),
            P('Êù±‰∫¨', 'Èñ¢Êù±', 35.682, 139.759, ['ÊµÖËçâÂØ∫', 'ÊòéÊ≤ªÁ•ûÂÆÆ', 'Êù±‰∫¨„Çπ„Ç´„Ç§„ÉÑ„É™„Éº']),
            P('Á•ûÂ•àÂ∑ù', 'Èñ¢Êù±', 35.447, 139.642, ['„Åø„Å™„Å®„Åø„Çâ„ÅÑ', 'ÈéåÂÄâ„ÉªÈï∑Ë∞∑ÂØ∫', 'ÁÆ±Ê†πÁ•ûÁ§æ']),
            P('Êñ∞ÊΩü', '‰∏≠ÈÉ®', 37.916, 139.036, ['‰ΩêÊ∏°Â≥∂', 'Ë∂äÂæåÊπØÊ≤¢', 'Âº•ÂΩ¶Á•ûÁ§æ']),
            P('ÂØåÂ±±', '‰∏≠ÈÉ®', 36.695, 137.213, ['Á´ãÂ±±ÈªíÈÉ®„Ç¢„É´„Éö„É≥„É´„Éº„Éà', 'Èõ®Êô¥Êµ∑Â≤∏', 'ÁëûÈæçÂØ∫']),
            P('Áü≥Â∑ù', '‰∏≠ÈÉ®', 36.561, 136.656, ['ÂÖºÂÖ≠Âúí', '„Å≤„Åå„ÅóËå∂Â±ãË°ó', 'ÂçÉÈáåÊµú„Å™„Åé„Åï„Éâ„É©„Ç§„Éñ„Ç¶„Çß„Ç§']),
            P('Á¶è‰∫ï', '‰∏≠ÈÉ®', 36.062, 136.224, ['Êù±Â∞ãÂùä', 'Ê∞∏Âπ≥ÂØ∫', 'ÊÅêÁ´úÂçöÁâ©È§®']),
            P('Â±±Ê¢®', '‰∏≠ÈÉ®', 35.664, 138.568, ['ÂØåÂ£´Â±±‰∫îÂêàÁõÆÔºàÂêâÁî∞Âè£Ôºâ', 'Ê≤≥Âè£Êπñ', '„Åª„Å£„Åü„Çâ„Åã„ÅóÊ∏©Ê≥â']),
            P('Èï∑Èáé', '‰∏≠ÈÉ®', 36.651, 138.181, ['‰∏äÈ´òÂú∞', 'ÊùæÊú¨Âüé', 'Âú∞ÁçÑË∞∑ÈáéÁåøÂÖ¨Ëãë']),
            P('Â≤êÈòú', '‰∏≠ÈÉ®', 35.391, 136.722, ['ÁôΩÂ∑ùÈÉ∑', '‰∏ãÂëÇÊ∏©Ê≥â', 'È´òÂ±±„ÉªÂè§„ÅÑÁî∫‰∏¶']),
            P('ÈùôÂ≤°', '‰∏≠ÈÉ®', 34.976, 138.383, ['ÂØåÂ£´ÂÆÆÊµÖÈñìÂ§ßÁ§æ', 'ÁÜ±Êµ∑Ê∏©Ê≥â', '‰∏â‰øù„ÅÆÊùæÂéü']),
            P('ÊÑõÁü•', '‰∏≠ÈÉ®', 35.181, 136.906, ['ÂêçÂè§Â±ãÂüé', 'ÁÜ±Áî∞Á•ûÂÆÆ', 'Áä¨Â±±Âüé']),
            P('‰∏âÈáç', 'ËøëÁïø', 34.730, 136.508, ['‰ºäÂã¢Á•ûÂÆÆ', '„Åä„Åã„ÅíÊ®™‰∏Å', 'È≥•ÁæΩÊ∞¥ÊóèÈ§®']),
            P('ÊªãË≥Ä', 'ËøëÁïø', 35.017, 135.854, ['ÂΩ¶Ê†πÂüé', '„Å≥„ÇèÊπñ„ÉÜ„É©„Çπ', 'ËøëÊ±üÂÖ´Âπ°']),
            P('‰∫¨ÈÉΩ', 'ËøëÁïø', 35.011, 135.768, ['Ê∏ÖÊ∞¥ÂØ∫', 'ÈáëÈñ£ÂØ∫', '‰ºèË¶ãÁ®≤Ëç∑Â§ßÁ§æ']),
            P('Â§ßÈò™', 'ËøëÁïø', 34.693, 135.502, ['Â§ßÈò™Âüé', 'ÈÅìÈ†ìÂ†Ä', '„É¶„Éã„Éê„Éº„Çµ„É´„Éª„Çπ„Çø„Ç∏„Ç™„Éª„Ç∏„É£„Éë„É≥']),
            P('ÂÖµÂ∫´', 'ËøëÁïø', 34.690, 135.195, ['Âß´Ë∑ØÂüé', 'ÂåóÈáéÁï∞‰∫∫È§®', 'ÊúâÈ¶¨Ê∏©Ê≥â']),
            P('Â•àËâØ', 'ËøëÁïø', 34.685, 135.805, ['Êù±Â§ßÂØ∫', 'Êò•Êó•Â§ßÁ§æ', 'Â•àËâØÂÖ¨ÂúíÔºàÈπøÔºâ']),
            P('ÂíåÊ≠åÂ±±', 'ËøëÁïø', 34.230, 135.170, ['ÁÜäÈáéÂè§ÈÅì', 'ÁôΩÊµú', 'È´òÈáéÂ±±']),
            P('È≥•Âèñ', '‰∏≠ÂõΩ', 35.501, 134.235, ['È≥•ÂèñÁ†Ç‰∏ò', '‰∏âÂæ≥Â±±‰∏â‰ΩõÂØ∫', 'ÁöÜÁîüÊ∏©Ê≥â']),
            P('Â≥∂Ê†π', '‰∏≠ÂõΩ', 35.472, 133.050, ['Âá∫Èõ≤Â§ßÁ§æ', 'Ë∂≥Á´ãÁæéË°ìÈ§®', 'ÁéâÈÄ†Ê∏©Ê≥â']),
            P('Â≤°Â±±', '‰∏≠ÂõΩ', 34.656, 133.919, ['ÂÄâÊï∑ÁæéË¶≥Âú∞Âå∫', 'ÂæåÊ•ΩÂúí', 'È∑≤ÁæΩÂ±±Â±ïÊúõÂè∞']),
            P('Â∫ÉÂ≥∂', '‰∏≠ÂõΩ', 34.385, 132.455, ['Âé≥Â≥∂Á•ûÁ§æÔºàÂÆÆÂ≥∂Ôºâ', 'ÂéüÁàÜ„Éâ„Éº„É†', 'Â∞æÈÅì']),
            P('Â±±Âè£', '‰∏≠ÂõΩ', 34.185, 131.471, ['ËßíÂ≥∂Â§ßÊ©ã', 'ÁßãÂêâÂè∞„ÉªÁßãËä≥Ê¥û', 'ÂÖÉ‰πÉÈöÖÁ•ûÁ§æ']),
            P('Âæ≥Â≥∂', 'ÂõõÂõΩ', 34.070, 134.554, ['Â§ßÊ≠©Âç±„ÉªÂ∞èÊ≠©Âç±', 'Á•ñË∞∑„ÅÆ„Åã„Åö„ÇâÊ©ã', 'È≥¥ÈñÄ„ÅÆÊ∏¶ÊΩÆ']),
            P('È¶ôÂ∑ù', 'ÂõõÂõΩ', 34.342, 134.046, ['Áõ¥Â≥∂Ôºà„Ç¢„Éº„ÉàÔºâ', 'Ê†óÊûóÂÖ¨Âúí', 'Â∞èË±ÜÂ≥∂„Ç®„É≥„Ç∏„Çß„É´„É≠„Éº„Éâ']),
            P('ÊÑõÂ™õ', 'ÂõõÂõΩ', 33.841, 132.766, ['ÈÅìÂæåÊ∏©Ê≥â', 'ÊùæÂ±±Âüé', '„Åó„Åæ„Å™„ÅøÊµ∑ÈÅì']),
            P('È´òÁü•', 'ÂõõÂõΩ', 33.559, 133.531, ['„Å≤„Çç„ÇÅÂ∏ÇÂ†¥', 'Âõõ‰∏áÂçÅÂ∑ù', 'Ê°ÇÊµú']),
            P('Á¶èÂ≤°', '‰πùÂ∑û„ÉªÊ≤ñÁ∏Ñ', 33.590, 130.401, ['Â§™ÂÆ∞Â∫úÂ§©Ê∫ÄÂÆÆ', '„Ç≠„É£„Éä„É´„Ç∑„ÉÜ„Ç£ÂçöÂ§ö', 'Á≥∏Â≥∂']),
            P('‰ΩêË≥Ä', '‰πùÂ∑û„ÉªÊ≤ñÁ∏Ñ', 33.249, 130.298, ['ÂêâÈáé„É∂ÈáåÈÅ∫Ë∑°', 'Ê≠¶ÈõÑÊ∏©Ê≥â', 'ÂëºÂ≠êÊúùÂ∏Ç']),
            P('Èï∑Â¥é', '‰πùÂ∑û„ÉªÊ≤ñÁ∏Ñ', 32.750, 129.877, ['„Ç∞„É©„Éê„ÉºÂúí', 'Âπ≥ÂíåÂÖ¨Âúí', '‰∫îÂ≥∂ÂàóÂ≥∂']),
            P('ÁÜäÊú¨', '‰πùÂ∑û„ÉªÊ≤ñÁ∏Ñ', 32.789, 130.741, ['ÁÜäÊú¨Âüé', 'ÈªíÂ∑ùÊ∏©Ê≥â', 'ÈòøËòáÂ±±']),
            P('Â§ßÂàÜ', '‰πùÂ∑û„ÉªÊ≤ñÁ∏Ñ', 33.239, 131.609, ['Âà•Â∫úÂú∞ÁçÑ„ÇÅ„Åê„Çä', 'Áî±Â∏ÉÈô¢', 'ÂõΩÊù±ÂçäÂ≥∂']),
            P('ÂÆÆÂ¥é', '‰πùÂ∑û„ÉªÊ≤ñÁ∏Ñ', 31.911, 131.423, ['È´òÂçÉÁ©ÇÂ≥°', 'ÈùíÂ≥∂Á•ûÁ§æ', 'ÈµúÊà∏Á•ûÂÆÆ']),
            P('ÈπøÂÖêÂ≥∂', '‰πùÂ∑û„ÉªÊ≤ñÁ∏Ñ', 31.596, 130.557, ['Ê°úÂ≥∂', 'ÈúßÂ≥∂Á•ûÂÆÆ', 'Â±ã‰πÖÂ≥∂']),
            P('Ê≤ñÁ∏Ñ', '‰πùÂ∑û„ÉªÊ≤ñÁ∏Ñ', 26.212, 127.681, ['Áæé„ÇâÊµ∑Ê∞¥ÊóèÈ§®', 'ÊñéÂ†¥Âæ°Â∂Ω', 'Âè§ÂÆáÂà©Â§ßÊ©ã']),
        ];
        function P(name, region, lat, lng, spots) { return { name, region, lat, lng, spots }; }

        /* ======= „ÅîÂΩìÂú∞„Ç∞„É´„É° ======= */
        const FOODS = {
            'ÂåóÊµ∑ÈÅì': ['„Ç∏„É≥„ÇÆ„Çπ„Ç´„É≥', '„Çπ„Éº„Éó„Ç´„É¨„Éº', 'Êµ∑ÈÆÆ‰∏º'],
            'ÈùíÊ£Æ': ['„Åõ„Çì„Åπ„ÅÑÊ±Å', 'Â§ßÈñì„Åæ„Åê„Çç', '„Çä„Çì„Åî'],
            'Â≤©Êâã': ['„Çè„Çì„Åì„Åù„Å∞', '„Åò„ÇÉ„Åò„ÇÉÈ∫∫', 'ÁõõÂ≤°ÂÜ∑È∫∫'],
            'ÂÆÆÂüé': ['Áâõ„Åü„Çì', '„Åö„Çì„Å†È§Ö', 'Á¨π„Åã„Åæ„Åº„Åì'],
            'ÁßãÁî∞': ['„Åç„Çä„Åü„Çì„ÅΩ', '„ÅÑ„Å∂„Çä„Åå„Å£„Åì', 'Á®≤Â∫≠„ÅÜ„Å©„Çì'],
            'Â±±ÂΩ¢': ['„Å†„Åó', 'ËäãÁÖÆ', 'Êùø„Åù„Å∞'],
            'Á¶èÂ≥∂': ['ÂñúÂ§öÊñπ„É©„Éº„É°„É≥', '„ÇΩ„Éº„Çπ„Ç´„ÉÑ‰∏º', '„Åæ„Åæ„Å©„Åä„Çã'],
            'Ëå®Âüé': ['„ÅÇ„Çì„Åì„ÅÜÈçã', 'Ê∞¥Êà∏Á¥çË±Ü', 'Âπ≤„ÅóËäã'],
            'Ê†ÉÊú®': ['ÂÆáÈÉΩÂÆÆÈ§ÉÂ≠ê', '‰ΩêÈáé„É©„Éº„É°„É≥', '„ÅÑ„Å°„Åî'],
            'Áæ§È¶¨': ['Ê∞¥Ê≤¢„ÅÜ„Å©„Çì', '„ÇÇ„Å§ÁÖÆ', 'ÁÑº„Åç„Åæ„Çì„Åò„ÇÖ„ÅÜ'],
            'ÂüºÁéâ': ['ËÇâÊ±Å„ÅÜ„Å©„Çì', 'ËçâÂä†„Åõ„Çì„Åπ„ÅÑ', 'ÂçÅ‰∏áÁü≥„Åæ„Çì„Åò„ÇÖ„ÅÜ'],
            'ÂçÉËëâ': ['„Å™„ÇÅ„Çç„ÅÜ', 'ËêΩËä±Áîü', 'ÂãùÊµ¶„Çø„É≥„Çø„É≥„É°„É≥'],
            'Êù±‰∫¨': ['Ê±üÊà∏ÂâçÂØøÂè∏', '„ÇÇ„Çì„Åò„ÇÉÁÑº„Åç', 'Â§©„Å∑„Çâ'],
            'Á•ûÂ•àÂ∑ù': ['„Çµ„É≥„Éû„Éº„É°„É≥', 'Â¥éÈôΩËªí„Ç∑„Ç¶„Éû„Ç§', 'Áîü„Åó„Çâ„Åô‰∏º'],
            'Êñ∞ÊΩü': ['„Å∏„Åé„Åù„Å∞', '„Çø„É¨„Ç´„ÉÑ‰∏º', 'Êó•Êú¨ÈÖí„Å®ËÇ¥'],
            'ÂØåÂ±±': ['„Åæ„ÅôÂØøÂè∏', 'ÁôΩ„Åà„Å≥', '„Å∂„Çä'],
            'Áü≥Â∑ù': ['„ÅÆ„Å©„Åê„Çç', 'ÈáëÊ≤¢„Ç´„É¨„Éº', 'Âä†Ë≥ÄÈáéËèúÊñôÁêÜ'],
            'Á¶è‰∫ï': ['Ë∂äÂâç„Åù„Å∞', '„ÇΩ„Éº„Çπ„Ç´„ÉÑ‰∏º', 'Ë∂äÂâç„Åå„Å´'],
            'Â±±Ê¢®': ['„Åª„ÅÜ„Å®„ÅÜ', '‰ø°ÁéÑÈ§Ö', 'È≥•„ÇÇ„Å§ÁÖÆ'],
            'Èï∑Èáé': ['‰ø°Â∑û„Åù„Å∞', '„Åä„ÇÑ„Åç', 'ÈáéÊ≤¢Ëèú'],
            'Â≤êÈòú': ['È£õÈ®®Áâõ', 'Êú¥ËëâÂë≥Âôå', '‰∫îÂπ≥È§Ö'],
            'ÈùôÂ≤°': ['ÊµúÂêçÊπñ„ÅÜ„Å™„Åé', 'ÂØåÂ£´ÂÆÆ„ÇÑ„Åç„Åù„Å∞', 'Áîü„Åó„Çâ„Åô'],
            'ÊÑõÁü•': ['Âë≥Âôå„Ç´„ÉÑ', '„Å≤„Å§„Åæ„Å∂„Åó', 'Â§©„ÇÄ„Åô'],
            '‰∏âÈáç': ['‰ºäÂã¢„ÅÜ„Å©„Çì', 'ÊùæÈò™Áâõ', 'Ëµ§Á¶è'],
            'ÊªãË≥Ä': ['ËøëÊ±üÁâõ', 'ÈÆíÂØøÂè∏', 'Ëµ§„Åì„Çì„Å´„ÇÉ„Åè'],
            '‰∫¨ÈÉΩ': ['ÊπØË±ÜËÖê', 'ÊäπËå∂', '„Å´„Åó„Çì„Åù„Å∞'],
            'Â§ßÈò™': ['„Åü„ÅìÁÑº„Åç', '„ÅäÂ•Ω„ÅøÁÑº„Åç', '‰∏≤„Ç´„ÉÑ'],
            'ÂÖµÂ∫´': ['Á•ûÊà∏Áâõ', 'ÊòéÁü≥ÁÑº', '„Åù„Å∞„ÇÅ„Åó'],
            'Â•àËâØ': ['Êüø„ÅÆËëâÂØøÂè∏', '‰∏âËº™„Åù„ÅÜ„ÇÅ„Çì', 'Â•àËâØÊº¨'],
            'ÂíåÊ≠åÂ±±': ['ÂçóÈ´òÊ¢Ö', 'Áîü„Åæ„Åê„Çç', 'ÂíåÊ≠åÂ±±„É©„Éº„É°„É≥'],
            'È≥•Âèñ': ['ÊùæËëâ„Åå„Å´', 'ÁâõÈ™®„É©„Éº„É°„É≥', 'Á†Ç‰∏ò„Çâ„Å£„Åç„Çá„ÅÜ'],
            'Â≥∂Ê†π': ['Âá∫Èõ≤„Åù„Å∞', '„Åó„Åò„ÅøÊñôÁêÜ', '„ÅÆ„Å©„Åê„Çç'],
            'Â≤°Â±±': ['„Å∞„Çâ„Åö„Åó', '„Éá„Éü„Ç´„ÉÑ‰∏º', '„Åç„Å≥„Å†„Çì„Åî'],
            'Â∫ÉÂ≥∂': ['Â∫ÉÂ≥∂È¢®„ÅäÂ•Ω„ÅøÁÑº„Åç', 'Áâ°Ë†£', 'Ê±Å„Å™„ÅóÊãÖ„ÄÖÈ∫∫'],
            'Â±±Âè£': ['„Åµ„Åê', 'Áì¶„Åù„Å∞', 'Â§ñÈÉé'],
            'Âæ≥Â≥∂': ['ÈòøÊ≥¢Â∞æÈ∂è', 'Âæ≥Â≥∂„É©„Éº„É°„É≥', '„Åô„Å†„Å°ÊñôÁêÜ'],
            'È¶ôÂ∑ù': ['ËÆÉÂ≤ê„ÅÜ„Å©„Çì', 'È™®‰ªòÈ≥•', '„Ç™„É™„Éº„ÉñÁâõ'],
            'ÊÑõÂ™õ': ['ÈØõ„ÇÅ„Åó', '„Åò„ÇÉ„ÅìÂ§©', '„Åø„Åã„Çì'],
            'È´òÁü•': ['„Åã„Å§„Åä„ÅÆ„Åü„Åü„Åç', 'ÁöøÈâ¢ÊñôÁêÜ', 'Áî∞ËàéÂØøÂè∏'],
            'Á¶èÂ≤°': ['ÂçöÂ§ö„É©„Éº„É°„É≥', '„ÇÇ„Å§Èçã', 'ÊòéÂ§™Â≠ê'],
            '‰ΩêË≥Ä': ['ÂëºÂ≠ê„ÅÑ„Åã', '‰ΩêË≥ÄÁâõ', '„Ç∑„Ç∑„É™„Ç¢„É≥„É©„Ç§„Çπ'],
            'Èï∑Â¥é': ['Èï∑Â¥é„Å°„ÇÉ„Çì„ÅΩ„Çì', 'Áöø„ÅÜ„Å©„Çì', '„Ç´„Çπ„ÉÜ„É©'],
            'ÁÜäÊú¨': ['È¶¨Âà∫„Åó', 'Â§™Âπ≥Ááï', 'ÁÜäÊú¨„É©„Éº„É°„É≥'],
            'Â§ßÂàÜ': ['„Å®„ÇäÂ§©', '„Å†„Çì„ÅîÊ±Å', '„Çä„ÇÖ„ÅÜ„Åç„ÇÖ„ÅÜ'],
            'ÂÆÆÂ¥é': ['„ÉÅ„Ç≠„É≥ÂçóËõÆ', 'Âú∞È∂èÁÇ≠ÁÅ´ÁÑº', '„Éû„É≥„Ç¥„Éº'],
            'ÈπøÂÖêÂ≥∂': ['ÈªíË±öÊñôÁêÜ', '„Åó„Çç„Åè„Åæ', '„Åï„Å§„ÅæÊèö„Åí'],
            'Ê≤ñÁ∏Ñ': ['„ÇΩ„Éº„Ç≠„Åù„Å∞', '„Çø„Ç≥„É©„Ç§„Çπ', '„É©„Éï„ÉÜ„Éº'],
        };

        const TABELOG_PREF_SLUG = {
            'ÂåóÊµ∑ÈÅì': 'hokkaido', 'ÈùíÊ£Æ': 'aomori', 'Â≤©Êâã': 'iwate', 'ÂÆÆÂüé': 'miyagi', 'ÁßãÁî∞': 'akita', 'Â±±ÂΩ¢': 'yamagata', 'Á¶èÂ≥∂': 'fukushima',
            'Ëå®Âüé': 'ibaraki', 'Ê†ÉÊú®': 'tochigi', 'Áæ§È¶¨': 'gunma', 'ÂüºÁéâ': 'saitama', 'ÂçÉËëâ': 'chiba', 'Êù±‰∫¨': 'tokyo', 'Á•ûÂ•àÂ∑ù': 'kanagawa',
            'Êñ∞ÊΩü': 'niigata', 'ÂØåÂ±±': 'toyama', 'Áü≥Â∑ù': 'ishikawa', 'Á¶è‰∫ï': 'fukui', 'Â±±Ê¢®': 'yamanashi', 'Èï∑Èáé': 'nagano', 'Â≤êÈòú': 'gifu',
            'ÈùôÂ≤°': 'shizuoka', 'ÊÑõÁü•': 'aichi', '‰∏âÈáç': 'mie',
            'ÊªãË≥Ä': 'shiga', '‰∫¨ÈÉΩ': 'kyoto', 'Â§ßÈò™': 'osaka', 'ÂÖµÂ∫´': 'hyogo', 'Â•àËâØ': 'nara', 'ÂíåÊ≠åÂ±±': 'wakayama',
            'È≥•Âèñ': 'tottori', 'Â≥∂Ê†π': 'shimane', 'Â≤°Â±±': 'okayama', 'Â∫ÉÂ≥∂': 'hiroshima', 'Â±±Âè£': 'yamaguchi',
            'Âæ≥Â≥∂': 'tokushima', 'È¶ôÂ∑ù': 'kagawa', 'ÊÑõÂ™õ': 'ehime', 'È´òÁü•': 'kochi',
            'Á¶èÂ≤°': 'fukuoka', '‰ΩêË≥Ä': 'saga', 'Èï∑Â¥é': 'nagasaki', 'ÁÜäÊú¨': 'kumamoto', 'Â§ßÂàÜ': 'oita', 'ÂÆÆÂ¥é': 'miyazaki', 'ÈπøÂÖêÂ≥∂': 'kagoshima', 'Ê≤ñÁ∏Ñ': 'okinawa'
        };

        /* ======= „É©„Éô„É´ ======= */
        const URBAN_PREFS = new Set(['Êù±‰∫¨', 'Á•ûÂ•àÂ∑ù', 'ÂçÉËëâ', 'ÂüºÁéâ', 'Â§ßÈò™', 'ÂÖµÂ∫´', '‰∫¨ÈÉΩ', 'ÊÑõÁü•', 'Á¶èÂ≤°', 'ÂÆÆÂüé', 'Â∫ÉÂ≥∂', 'ÈùôÂ≤°', 'Ëå®Âüé', 'Êñ∞ÊΩü', 'Â≤°Â±±', 'ÁÜäÊú¨']);
        const COASTAL_PREFS = new Set(['ÂåóÊµ∑ÈÅì', 'ÈùíÊ£Æ', 'Â≤©Êâã', 'ÂÆÆÂüé', 'ÁßãÁî∞', 'Â±±ÂΩ¢', 'Á¶èÂ≥∂', 'Ëå®Âüé', 'ÂçÉËëâ', 'Êù±‰∫¨', 'Á•ûÂ•àÂ∑ù', 'Êñ∞ÊΩü', 'ÂØåÂ±±', 'Áü≥Â∑ù', 'Á¶è‰∫ï', 'ÈùôÂ≤°', 'ÊÑõÁü•', '‰∏âÈáç', 'ÂíåÊ≠åÂ±±', 'Âæ≥Â≥∂', 'È¶ôÂ∑ù', 'ÊÑõÂ™õ', 'È´òÁü•', 'Á¶èÂ≤°', '‰ΩêË≥Ä', 'Èï∑Â¥é', 'ÁÜäÊú¨', 'Â§ßÂàÜ', 'ÂÆÆÂ¥é', 'ÈπøÂÖêÂ≥∂', 'Ê≤ñÁ∏Ñ', 'Â±±Âè£', 'È≥•Âèñ', 'Â≥∂Ê†π']);

        /* ========= ‰ΩéÈ†ªÂ∫¶„Ç≠„É•„Éº & „Éê„ÉÉ„ÇØ„Ç™„Éï ========= */
        class Throttler { constructor(minIntervalMs) { this.minInterval = minIntervalMs; this._last = 0; this._chain = Promise.resolve(); } schedule(task) { this._chain = this._chain.then(async () => { const now = Date.now(); const wait = Math.max(0, this._last + this.minInterval - now); if (wait) await new Promise(r => setTimeout(r, wait)); this._last = Date.now(); return task(); }); return this._chain; } }
        const throttlers = { nominatim: new Throttler(1200), osrm: new Throttler(300) };
        async function fetchWithRetry(url, options = {}, { host = 'nominatim', retries = 3, baseDelay = 700 } = {}) {
            const doFetch = () => fetch(url, options); const exec = () => throttlers[host].schedule(doFetch);
            for (let i = 0; i <= retries; i++) {
                try {
                    const res = await exec();
                    if (res.ok) return res;
                    if (res.status === 429 || (res.status >= 500 && res.status < 600)) {
                        if (i === retries) return res; const jitter = Math.random() * 300; await new Promise(r => setTimeout(r, baseDelay * Math.pow(2, i) + jitter)); continue;
                    }
                    return res;
                } catch (e) {
                    if (i === retries) throw e; const jitter = Math.random() * 300; await new Promise(r => setTimeout(r, baseDelay * Math.pow(2, i) + jitter));
                }
            }
        }

        /* ========= „Ç≠„É£„ÉÉ„Ç∑„É• ========= */
        const memCache = new Map();
        function cacheKey(prefix, obj) { return prefix + ":" + JSON.stringify(obj); }
        function getLocalCache(key) { try { const raw = localStorage.getItem(key); if (!raw) return null; const { ts, value } = JSON.parse(raw); if (Date.now() - ts > CACHE_TTL_MS) { localStorage.removeItem(key); return null; } return value; } catch { return null; } }
        function setLocalCache(key, value) { try { localStorage.setItem(key, JSON.stringify({ ts: Date.now(), value })); } catch { } }

        /* ========= ÈÄÜ„Ç∏„Ç™/„Ç∏„Ç™/„É´„Éº„Éà ========= */
        const UA_HDR = { 'User-Agent': 'DartsNoTabi/1.0 (+demo)' };
        function emailParam() { return CONTACT_EMAIL ? `&email=${encodeURIComponent(CONTACT_EMAIL)}` : ''; }

        async function geocodeJa(text) {
            const key = cacheKey('geo', { text }); if (memCache.has(key)) return memCache.get(key);
            const lc = getLocalCache(key); if (lc) { memCache.set(key, lc); return lc; }
            const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&limit=1&countrycodes=jp&accept-language=ja&q=${encodeURIComponent(text)}${emailParam()}`;
            const res = await fetchWithRetry(url, { headers: UA_HDR }, { host: 'nominatim', retries: 3, baseDelay: 900 });
            if (!res.ok) { memCache.set(key, null); return null; }
            const arr = await res.json(); const hit = arr && arr[0] ? { lat: +arr[0].lat, lng: +arr[0].lon } : null;
            memCache.set(key, hit); setLocalCache(key, hit); return hit;
        }
        async function reverseGeocodeJa(lat, lng) {
            const rlat = Math.round(lat * 20000) / 20000, rlng = Math.round(lng * 20000) / 20000;
            const key = cacheKey('rev', { lat: rlat, lng: rlng }); if (memCache.has(key)) return memCache.get(key);
            const lc = getLocalCache(key); if (lc) { memCache.set(key, lc); return lc; }
            const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${rlat}&lon=${rlng}&zoom=18&addressdetails=1&accept-language=ja${emailParam()}`;
            const res = await fetchWithRetry(url, { headers: UA_HDR }, { host: 'nominatim', retries: 3, baseDelay: 900 });
            if (!res.ok) { memCache.set(key, {}); return {}; }
            const data = await res.json(); const addr = data.address || {};
            memCache.set(key, addr); setLocalCache(key, addr); return addr;
        }
        async function driveDurationSeconds(origin, dest) {
            const key = cacheKey('osrm', { o: origin, d: dest }); if (memCache.has(key)) return memCache.get(key);
            const url = `https://router.project-osrm.org/route/v1/driving/${dest.lng},${dest.lat};${origin.lng},${origin.lat}?overview=false&alternatives=false&annotations=duration`;
            const res = await fetchWithRetry(url, {}, { host: 'osrm', retries: 2, baseDelay: 700 });
            if (!res.ok) { memCache.set(key, null); return null; }
            const data = await res.json(); const sec = data?.routes?.[0]?.duration ?? null; memCache.set(key, sec); return sec;
        }
        async function driveInfo(origin, dest) {
            const key = cacheKey('osrm2', { o: origin, d: dest }); if (memCache.has(key)) return memCache.get(key);
            const url = `https://router.project-osrm.org/route/v1/driving/${origin.lng},${origin.lat};${dest.lng},${dest.lat}?overview=false`;
            const res = await fetchWithRetry(url, {}, { host: 'osrm', retries: 2, baseDelay: 700 });
            if (!res.ok) { memCache.set(key, null); return null; }
            const data = await res.json();
            const r = data?.routes?.[0]; const out = r ? { duration: r.duration, distance: r.distance } : null;
            memCache.set(key, out); return out;
        }
        function fmtMinutes(sec) { if (sec == null) return '‚Äî'; const m = Math.round(sec / 60); if (m < 60) return `${m}ÂàÜ`; const h = Math.floor(m / 60), mm = m % 60; return mm ? `${h}ÊôÇÈñì${mm}ÂàÜ` : `${h}ÊôÇÈñì`; }
        function fmtKm(m) { if (m == null) return '‚Äî'; const km = m / 1000; return (km < 100) ? `${km.toFixed(1)}km` : `${Math.round(km)}km`; }

        /* ========= UIÁîüÊàê ========= */
        const regionChipsEl = document.getElementById('regionChips');
        const vibeChipsEl = document.getElementById('vibeChips');
        const locChipsEl = document.getElementById('locChips');

        try {
            renderRegionChips(); renderExtraFilters(); updateHint();
        } catch (e) {
            console.error('Init UI error:', e);
        }

        function renderRegionChips() {
            const all = chipEl('„Åô„Åπ„Å¶ÈÅ∏Êäû', '#10b981', true, true); all.classList.add('select-all'); regionChipsEl.appendChild(all);
            REGIONS.forEach(r => regionChipsEl.appendChild(chipEl(r.id, r.color, true, false, r.id)));
            regionChipsEl.addEventListener('click', e => {
                const lab = e.target.closest('.chip'); if (!lab) return; e.preventDefault(); e.stopPropagation();
                if (lab.classList.contains('select-all')) {
                    const now = !(lab.dataset.checked === 'true'); setChip(lab, now);
                    regionChipsEl.querySelectorAll('.chip:not(.select-all)').forEach(c => setChip(c, now));
                } else {
                    setChip(lab, !(lab.dataset.checked === 'true'));
                    const everyOn = Array.from(regionChipsEl.querySelectorAll('.chip:not(.select-all) input')).every(i => i.checked);
                    setChip(regionChipsEl.querySelector('.select-all'), everyOn);
                }
                updateHint();
            });
        }
        function renderExtraFilters() {
            vibeChipsEl.appendChild(chipEl('ÈÉΩÂøÉ', '#f97316', false, false, 'urban'));
            vibeChipsEl.appendChild(chipEl('Ëá™ÁÑ∂', '#22c55e', false, false, 'nature'));
            vibeChipsEl.addEventListener('click', e => {
                const lab = e.target.closest('.chip'); if (!lab) return; e.preventDefault();
                const now = !(lab.dataset.checked === 'true'); Array.from(vibeChipsEl.querySelectorAll('.chip')).forEach(c => setChip(c, false)); setChip(lab, now); updateHint();
            });
            locChipsEl.appendChild(chipEl('Êµ∑Ê≤ø„ÅÑ', '#0ea5e9', false, false, 'coastal'));
            locChipsEl.appendChild(chipEl('ÂÜÖÈô∏', '#a78bfa', false, false, 'inland'));
            locChipsEl.addEventListener('click', e => {
                const lab = e.target.closest('.chip'); if (!lab) return; e.preventDefault();
                const now = !(lab.dataset.checked === 'true'); Array.from(locChipsEl.querySelectorAll('.chip')).forEach(c => setChip(c, false)); setChip(lab, now); updateHint();
            });
        }
        function chipEl(label, color, checked = false, isAll = false, value = '') {
            const lab = document.createElement('label'); lab.className = 'chip'; lab.dataset.checked = String(checked); if (value) lab.dataset.value = value;
            lab.innerHTML = `<input type="checkbox" ${checked ? 'checked' : ''} ${isAll ? 'aria-label="„Åô„Åπ„Å¶ÈÅ∏Êäû"' : ''} value="${value}">
                 <span class="dot" style="background:${color}"></span>${label}`;
            return lab;
        }
        function setChip(el, on) { el.dataset.checked = String(on); const input = el.querySelector('input'); if (input) input.checked = on; }

        function getSelectedRegions() { return Array.from(regionChipsEl.querySelectorAll('.chip:not(.select-all) input')).filter(i => i.checked).map(i => i.value); }
        function getVibe() { const on = vibeChipsEl.querySelector('.chip[data-checked="true"]'); return on ? on.dataset.value : null; }
        function getLocation() { const on = locChipsEl.querySelector('.chip[data-checked="true"]'); return on ? on.dataset.value : null; }
        function updateHint() {
            const r = getSelectedRegions(); const vibe = getVibe(); const loc = getLocation(); const tags = [];
            if (vibe === 'urban') tags.push('ÈÉΩÂøÉ'); else if (vibe === 'nature') tags.push('Ëá™ÁÑ∂');
            if (loc === 'coastal') tags.push('Êµ∑Ê≤ø„ÅÑ'); else if (loc === 'inland') tags.push('ÂÜÖÈô∏');
            document.getElementById('hint').textContent = r.length ? `ÈÅ∏ÊäûÔºö${r.join('„Éª')}${tags.length ? 'Ôºè' + tags.join('„Éª') : ''}` : 'Âú∞Êñπ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
        }

        /* ========= „Éû„ÉÉ„Éó ========= */
        const map = L.map('map', { zoomControl: true, scrollWheelZoom: true, preferCanvas: true, zoomSnap: 0.25, zoomDelta: 0.25, wheelDebounceTime: 40, wheelPxPerZoomLevel: 80 }).setView([35.6, 139.6], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18, attribution: '&copy; OpenStreetMap', updateWhenZooming: false, keepBuffer: 3, detectRetina: true }).addTo(map);

        /* üìç„Éî„É≥ */
        function makeDartIcon() { return L.divIcon({ className: '', html: `<div class="pin-wrap"><div class="pin-emoji" aria-hidden="true">üìç</div><span class="impact"></span></div>`, iconSize: [60, 60], iconAnchor: [30, 55] }); }
        let marker = null;

        /* ========= ÈÉΩÈÅìÂ∫úÁúåGeoJSONÔºàÊèèÁîª„Åó„Å™„ÅÑÔºâ ========= */
        const PREF_GEO_URL = "https://raw.githubusercontent.com/piuccio/open-data-jp-prefectures-geojson/master/output/prefectures.geojson";
        let PREF_FEATURES = []; const norm = s => s.replace(/(ÈÉΩ|ÈÅì|Â∫ú|Áúå)$/, '');
        function toFullJP(base) { if (base === 'ÂåóÊµ∑ÈÅì') return 'ÂåóÊµ∑ÈÅì'; if (base === 'Êù±‰∫¨') return 'Êù±‰∫¨ÈÉΩ'; if (base === 'Â§ßÈò™') return 'Â§ßÈò™Â∫ú'; if (base === '‰∫¨ÈÉΩ') return '‰∫¨ÈÉΩÂ∫ú'; return base + 'Áúå'; }
        const NAME_TO_REGION = new Map(PREFS.map(p => [p.name, p.region]));
        function nearestPrefBaseName(lng, lat) { let best = null, d2min = Infinity; for (const p of PREFS) { const d2 = (p.lat - lat) ** 2 + (p.lng - lng) ** 2; if (d2 < d2min) { d2min = d2; best = p; } } return best ? best.name : null; }

        (async function loadPrefectures() {
            try {
                const gj = await (await fetch(PREF_GEO_URL)).json();
                PREF_FEATURES = (gj.features || []).map(f => {
                    const props = f.properties || {};
                    let nameJP = props.nam_ja || props.name_ja || props.kanji || props.pref || props.name || '';
                    const hasJP = /[\u3040-\u30ff\u3400-\u9fff]/.test(String(nameJP)); if (!hasJP) nameJP = '';
                    let base;
                    if (nameJP) { base = norm(nameJP); }
                    else { const c = turf.centroid(f).geometry.coordinates; base = nearestPrefBaseName(c[0], c[1]) || ''; nameJP = toFullJP(base); }
                    const region = NAME_TO_REGION.get(base) || null;

                    // Â§ñÂë®„Å†„ÅëÔºàÊµ∑ÂÅ¥Âà§ÂÆöÂêë„ÅëÔºâ
                    const boundaryLines = [];
                    const geom = f.geometry;
                    if (geom.type === 'Polygon') {
                        const outer = geom.coordinates[0];
                        boundaryLines.push(turf.lineString(outer));
                    } else if (geom.type === 'MultiPolygon') {
                        geom.coordinates.forEach(poly => {
                            const outer = poly[0];
                            boundaryLines.push(turf.lineString(outer));
                        });
                    }

                    f._bbox = turf.bbox(f);
                    f._center = turf.centerOfMass(f).geometry.coordinates;
                    f._baseName = base;
                    f._nameJP = /(ÈÉΩ|ÈÅì|Â∫ú|Áúå)$/.test(nameJP) ? nameJP : toFullJP(base);
                    f._region = region;
                    f._boundaryLines = boundaryLines;
                    return f;
                });
                const btn = document.getElementById('throwBtn'); btn.disabled = false; btn.textContent = 'üéØ „ÉÄ„Éº„ÉÑ„ÇíÊäï„Åí„Çã';
            } catch (e) {
                console.error('Failed to load prefectures GeoJSON', e);
                const btn = document.getElementById('throwBtn'); btn.disabled = true; btn.textContent = 'Ë™≠„ÅøËæº„ÅøÂ§±ÊïóÔºàÂÜçË™≠Ëæº„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºâ';
            }
        })();

        /* ========= JapanÂÜÖÂà§ÂÆö ========= */
        function isInAnyPref(pt) { for (const f of PREF_FEATURES) { if (turf.booleanPointInPolygon(pt, f)) return true; } return false; }
        function isSeaSideForFeature(feature, pt) {
            let nearest = null, best = Infinity;
            for (const line of feature._boundaryLines) {
                const np = turf.nearestPointOnLine(line, pt, { units: 'kilometers' }); const d = np.properties.dist;
                if (d < best) { best = d; nearest = np; }
            }
            if (!nearest) return false;
            const pB = nearest.geometry.coordinates;
            const pT = pt.geometry.coordinates;
            const v = [pB[0] - pT[0], pB[1] - pT[1]];
            const len = Math.hypot(v[0], v[1]); if (len === 0) return false;
            const unit = [v[0] / len, v[1] / len];
            const step = 1 / 111; // Á¥Ñ1km
            const pOut = [pB[0] + unit[0] * step, pB[1] + unit[1] * step];
            const probe = turf.point(pOut);
            return !isInAnyPref(probe);
        }

        /* ========= „Éï„Ç£„É´„Çø ========= */
        function getActivePrefPolygons() {
            const selectedRegions = new Set(getSelectedRegions()); const vibe = getVibe(); const loc = getLocation();
            return PREF_FEATURES.filter(f => {
                if (!(f._region && selectedRegions.has(f._region))) return false;
                const base = f._baseName;
                if (vibe === 'urban' && !URBAN_PREFS.has(base)) return false;
                if (vibe === 'nature' && URBAN_PREFS.has(base)) return false;
                if (loc === 'coastal' && !COASTAL_PREFS.has(base)) return false;
                if (loc === 'inland' && COASTAL_PREFS.has(base)) return false;
                return true;
            });
        }

        /* ========= „É©„É≥„ÉÄ„É†ÁÇπ ========= */
        function pickPrefByArea(features) {
            const weights = features.map(f => Math.max(1, turf.area(f))); const sum = weights.reduce((a, b) => a + b, 0);
            let r = Math.random() * sum; for (let i = 0; i < features.length; i++) { if ((r -= weights[i]) <= 0) return features[i]; }
            return features[features.length - 1];
        }
        function minDistanceToBoundaryKm(pt, boundaryLines) {
            if (!boundaryLines || !boundaryLines.length) return Infinity;
            let min = Infinity;
            for (const line of boundaryLines) {
                const d = turf.pointToLineDistance(pt, line, { units: 'kilometers' });
                if (d < min) min = d;
            }
            return min;
        }
        function randomPointInPolygon(feature, options = {}) {
            const { mode = null, maxTry = 200 } = options;
            const b = feature._bbox || turf.bbox(feature);
            let bestPt = null, bestScore = Infinity;

            for (let i = 0; i < maxTry; i++) {
                const pt = turf.point([Math.random() * (b[2] - b[0]) + b[0], Math.random() * (b[3] - b[1]) + b[1]]);
                if (!turf.booleanPointInPolygon(pt, feature)) continue;

                if (mode === 'coastal' || mode === 'inland') {
                    const d = minDistanceToBoundaryKm(pt, feature._boundaryLines);
                    if (mode === 'coastal') {
                        if (d <= 5 && isSeaSideForFeature(feature, pt)) return pt;
                        const score = (isSeaSideForFeature(feature, pt) ? d : d + 100);
                        if (score < bestScore) { bestScore = score; bestPt = pt; }
                    } else {
                        if (d >= 15) return pt;
                        const score = Math.abs(15 - d);
                        if (score < bestScore) { bestScore = score; bestPt = pt; }
                    }
                } else {
                    return pt;
                }
            }
            return bestPt || turf.point(feature._center || turf.centerOfMass(feature).geometry.coordinates);
        }

        /* ========= „Ç¢„Éâ„É¨„ÇπÈöéÂ±§ ========= */
        function toAdminLevels(addr) {
            const state = addr.state || addr.region || addr.province;
            const ward = addr.city_district || addr.borough || addr.ward;
            const city = addr.city || addr.town || addr.village || addr.municipality;
            const county = addr.county && (!String(city || '').includes(addr.county)) ? addr.county : null;
            const suburb = addr.suburb || addr.neighbourhood || addr.quarter;
            const hamlet = addr.hamlet || addr.locality;
            const arr = []; if (state) arr.push({ label: state }); if (city) arr.push({ label: city }); if (ward) arr.push({ label: ward }); if (county) arr.push({ label: county }); if (suburb) arr.push({ label: suburb }); if (hamlet) arr.push({ label: hamlet });
            return arr;
        }
        function pickPrefCity(addr) {
            const state = addr.state || addr.region || addr.province || '';
            const city = addr.city || addr.town || addr.village || addr.municipality || '';
            const ward = addr.city_district || addr.ward || '';
            const cityLike = city || ward; // Âå∫„Å†„ÅëËøî„Çã„Ç±„Éº„ÇπÂØæÁ≠ñ
            return { state, city: cityLike };
        }

        /* ========= „Ç≥„É≥„Éï„Çß„ÉÉ„ÉÜ„Ç£ ========= */
        function boomConfetti(lat, lng) {
            const layerPoint = map.latLngToContainerPoint([lat, lng]);
            const root = document.getElementById('confetti'); const frag = document.createDocumentFragment();
            const colors = ['#f43f5e', '#f59e0b', '#22c55e', '#06b6d4', '#8b5cf6', '#ef4444', '#eab308'];
            for (let i = 0; i < TIMING.confettiCount; i++) {
                const piece = document.createElement('i'); const x = layerPoint.x + (Math.random() * 80 - 40); const y = layerPoint.y + (Math.random() * 20 - 10);
                piece.style.setProperty('--x', x + 'px'); piece.style.setProperty('--y', y + 'px'); piece.style.setProperty('--drift', (Math.random() * 120 - 60) + 'px');
                piece.style.left = '0px'; piece.style.top = '0px'; piece.style.background = colors[Math.floor(Math.random() * colors.length)];
                frag.appendChild(piece); setTimeout(() => piece.remove(), 2000);
            }
            root.appendChild(frag);
        }
        function escapeHtml(s) { return s.replace(/[&<>"']/g, ch => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[ch])) }

        /* ========= „Ç∑„Éº„ÉàË°®Á§∫Áæ§ ========= */
        function renderSpotsByPrefBase(baseName, originLatLng, adminCity) {
            const pref = PREFS.find(p => p.name === baseName);
            const spotsEl = document.getElementById('spots'); spotsEl.innerHTML = '';
            const foodsEl = document.getElementById('foods'); foodsEl.innerHTML = '';
            if (pref) {
                (async () => {
                    for (let i = 0; i < pref.spots.length; i++) {
                        const s = pref.spots[i];
                        const card = document.createElement('div'); card.className = 'card';
                        const id = `spot-time-${i}-${Date.now()}`;
                        card.innerHTML = `<h4>üìç ${i + 1}. ${escapeHtml(s)}</h4>
                        <p><a href="https://www.google.com/search?q=${encodeURIComponent(pref.name + ' ' + s)}" target="_blank" rel="noreferrer">Google„ÅßË¶ã„Çã ‚Üó</a></p>
                        <div class="time" id="${id}">üöó ÊâÄË¶ÅÊôÇÈñì: Ë®àÁÆó‰∏≠‚Ä¶</div>`;
                        spotsEl.appendChild(card);
                        try {
                            const q = `${pref.name} ${s}`; const dest = await geocodeJa(q);
                            let txt = '‚Äî'; if (dest) { const sec = await driveDurationSeconds({ lat: originLatLng.lat, lng: originLatLng.lng }, dest); txt = fmtMinutes(sec); }
                            const el = document.getElementById(id); if (el) el.textContent = `üöó ÊâÄË¶ÅÊôÇÈñì: Á¥Ñ ${txt}`;
                        } catch { const el = document.getElementById(id); if (el) el.textContent = `üöó ÊâÄË¶ÅÊôÇÈñì: ‚Äî`; }
                        finally { document.getElementById('nominatimAttribution').hidden = false; }
                    }
                })();

                const list = FOODS[baseName] || [];
                const slug = TABELOG_PREF_SLUG[baseName];
                if (list.length && slug) {
                    list.forEach((name, idx) => {
                        const card = document.createElement('div'); card.className = 'card';
                        const areaSa = adminCity || 'ÂÖ®Âüü';
                        /* ‚ñº‚ñº „Åì„Åì„Å†„ÅëÂ§âÊõ¥ÔºöÈ£ü„Åπ„É≠„Ç∞„ÅÆ„Äå„É©„É≥„Ç≠„É≥„Ç∞„Äç‰∏¶„Å≥„Å´„Å™„Çã„Çà„ÅÜ„Éë„É©„É°„Éº„Çø„ÇíËøΩÂä† ‚ñº‚ñº */
                        const tabeUrl =
                            `https://tabelog.com/${slug}/rstLst/?vs=2&sa=${encodeURIComponent(areaSa)}&sk=${encodeURIComponent(name)}&sw=${encodeURIComponent(name)}&SrtT=rt&sort_mode=1`;
                        /* ‚ñ≤‚ñ≤ „Åì„Åì„Å†„ÅëÂ§âÊõ¥ ‚ñ≤‚ñ≤ */

                        card.innerHTML = `<h4>üçú ${idx + 1}. ${escapeHtml(name)}</h4>
                        <p><a href="${tabeUrl}" target="_blank" rel="noreferrer">È£ü„Åπ„É≠„Ç∞Ôºà„É©„É≥„Ç≠„É≥„Ç∞Ôºâ„Åß„ÅäÂ∫ó„ÇíÊé¢„Åô ‚Üó</a></p>`;
                        foodsEl.appendChild(card);
                    });
                } else {
                    foodsEl.innerHTML = `<div class="card"><h4>üçú „Éá„Éº„ÇøÊ∫ñÂÇô‰∏≠</h4><p>„Åì„ÅÆÈÉΩÈÅìÂ∫úÁúå„ÅÆ„Ç∞„É´„É°„ÅØ‰ªäÂæåËøΩÂä†„Åó„Åæ„Åô„ÄÇ</p></div>`;
                }

                document.getElementById('pickedPref').textContent = toFullJP(pref.name);
                document.getElementById('pickedRegion').textContent = pref.region;
            } else {
                document.getElementById('pickedPref').textContent = toFullJP(baseName || '‚Äî');
                document.getElementById('pickedRegion').textContent = '‚Äî';
                spotsEl.innerHTML = `<div class="card"><h4>„Éá„Éº„ÇøÊ∫ñÂÇô‰∏≠</h4><p>„Åì„ÅÆÈÉΩÈÅìÂ∫úÁúå„ÅÆ„Çπ„Éù„ÉÉ„ÉàÂÄôË£ú„ÅØ‰ªäÂæåËøΩÂä†„Åó„Åæ„Åô„ÄÇ</p></div>`;
                foodsEl.innerHTML = `<div class="card"><h4>üçú „Éá„Éº„ÇøÊ∫ñÂÇô‰∏≠</h4></div>`;
            }
        }
        function openSheet() { document.getElementById('sheet').classList.add('show'); }
        function closeSheet() { document.getElementById('sheet').classList.remove('show'); }

        function renderAdminChips(levels, lat, lng) {
            const wrap = document.getElementById('adminPath'); wrap.innerHTML = '';
            if (!levels || !levels.length) { const d = document.createElement('div'); d.className = 'pill'; d.textContent = '‰ΩèÊâÄ„ÇíÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü'; wrap.appendChild(d); }
            else { levels.forEach(l => { const e = document.createElement('div'); e.className = 'pill'; e.textContent = l.label; wrap.appendChild(e); }); }
            document.getElementById('nominatimAttribution').hidden = false;
            const osmLink = document.createElement('a');
            osmLink.href = `https://www.openstreetmap.org/?mlat=${lat}&mlon=${lng}#map=14/${lat}/${lng}`; osmLink.target = '_blank'; osmLink.rel = 'noreferrer';
            osmLink.textContent = '‚Üó OSM„Åß‰ΩçÁΩÆ„ÇíË¶ã„Çã'; osmLink.style.marginLeft = '8px'; osmLink.style.fontSize = '12px'; osmLink.style.color = '#0b3a5c'; osmLink.style.textDecoration = 'none';
            wrap.appendChild(osmLink);
        }

        /* ========= ÊºîÂá∫„Ç∑„Éº„Ç±„É≥„Çπ ========= */
        const REGION_BOX = {
            'ÂåóÊµ∑ÈÅì': { minLat: 41.3, maxLat: 45.7, minLng: 139.0, maxLng: 146.2 },
            'Êù±Âåó': { minLat: 37.0, maxLat: 41.6, minLng: 138.5, maxLng: 143.0 },
            'Èñ¢Êù±': { minLat: 34.8, maxLat: 37.7, minLng: 138.7, maxLng: 141.5 },
            '‰∏≠ÈÉ®': { minLat: 33.8, maxLat: 38.4, minLng: 135.8, maxLng: 140.2 },
            'ËøëÁïø': { minLat: 33.3, maxLat: 35.9, minLng: 134.2, maxLng: 137.2 },
            '‰∏≠ÂõΩ': { minLat: 33.8, maxLat: 36.0, minLng: 130.7, maxLng: 135.0 },
            'ÂõõÂõΩ': { minLat: 32.8, maxLat: 34.9, minLng: 131.8, maxLng: 135.2 },
            '‰πùÂ∑û„ÉªÊ≤ñÁ∏Ñ': { minLat: 24.0, maxLat: 34.1, minLng: 122.8, maxLng: 132.3 },
        };

        let animating = false;
        let lastPin = null; // {lat,lng, addr, prefBase, cityName}
        const throwBtn = document.getElementById('throwBtn');
        throwBtn.addEventListener('click', async () => {
            if (animating) return;
            if (!PREF_FEATURES.length) { shake(throwBtn); return; }
            const candidates = getActivePrefPolygons();
            if (!candidates.length) { shake(throwBtn); return; }

            animating = true; throwBtn.disabled = true;
            closeSheet(); if (marker) { map.removeLayer(marker); }
            disableInteractions(true);

            try {
                const picked = pickPrefByArea(candidates);
                const locPref = getLocation();
                const pt = randomPointInPolygon(picked, { mode: locPref });
                const [lng, lat] = pt.geometry.coordinates;

                await flyToCenter([36.0, 137.0], 5, TIMING.flyOutMs);
                await pause(TIMING.pauseAfterOut);

                const box = REGION_BOX[picked._region];
                if (box) { await flyBounds([[box.minLat, box.minLng], [box.maxLat, box.maxLng]], TIMING.flyToRegionMs); }
                else { await flyToCenter([lat, lng], 7, TIMING.flyToRegionMs); }

                await pause(TIMING.pauseBeforePin);

                marker = L.marker([lat, lng], { icon: makeDartIcon() }).addTo(map);
                boomConfetti(lat, lng);
                const addr = await reverseGeocodeJa(lat, lng).catch(() => ({}));
                const { state, city } = pickPrefCity(addr);
                await pause(TIMING.pinDropMs);

                const b = picked._bbox; await flyBounds([[b[1], b[0]], [b[3], b[2]]], TIMING.zoomToPrefMs);
                await flyToCenter([lat, lng], 12.5, TIMING.zoomToPinMs);

                renderSpotsByPrefBase(picked._baseName, { lat, lng }, city);
                renderAdminChips(toAdminLevels(addr), lat, lng);
                setTimeout(() => openSheet(), TIMING.sheetDelayMs);

                lastPin = { lat, lng, addr, prefBase: picked._baseName, cityName: city || '' };
            } catch (err) {
                console.error('throw sequence error:', err);
                alert('„Åô„Åø„Åæ„Åõ„Çì„ÄÅ„ÉÄ„Éº„ÉÑÊºîÂá∫„Åß„Ç®„É©„Éº„ÅåËµ∑„Åç„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ');
            } finally {
                disableInteractions(false);
                throwBtn.disabled = false;
                animating = false;
            }
        });
        document.getElementById('againBtn').addEventListener('click', () => document.getElementById('throwBtn').click());

        /* ========= Ë©≥Á¥∞„Ç™„Éº„Éê„Éº„É¨„Ç§ ========= */
        const detailEl = document.getElementById('detail');
        document.getElementById('decideBtn').addEventListener('click', async () => {
            if (!lastPin) { shake(document.getElementById('decideBtn')); return; }
            const origin = { lat: 35.681236, lng: 139.767125 }; // Êù±‰∫¨ÈßÖ
            const dest = { lat: lastPin.lat, lng: lastPin.lng };

            const rbox = document.getElementById('routeInfo');
            rbox.innerHTML = `<div>üöó ËªäÔºàÊ¶ÇÁÆóÔºâ: Ë®àÁÆó‰∏≠‚Ä¶</div>`;
            const info = await driveInfo(origin, dest);
            if (info) { rbox.innerHTML = `<div>üöó ËªäÔºàÊ¶ÇÁÆóÔºâ: Á¥Ñ ${fmtMinutes(info.duration)}ÔºàË∑ùÈõ¢ ${fmtKm(info.distance)}Ôºâ</div>`; }
            else { rbox.innerHTML = `<div>üöó ËªäÔºàÊ¶ÇÁÆóÔºâ: ‚Äî</div>`; }

            const a = lastPin.addr || {};
            const { state, city } = pickPrefCity(a);
            const words = (state && city) ? `${state} ${city}` : (state || city || '');
            const qRakuten = encodeURIComponent(words);
            const qAirbnb = encodeURIComponent(words);

            const rakuten = `https://kw.travel.rakuten.co.jp/keyword/Search.do?charset=utf-8&f_max=30&l-id=topC_search_keyword&f_query=${qRakuten}`;
            const airbnb = `https://www.airbnb.jp/s/${qAirbnb}/homes?search_mode=flex_destinations_search&refinement_paths%5B%5D=%2Fhomes&adults=2&children=0`;

            const routeLinks = document.getElementById('routeLinks');
            const gmapDrive = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent('Êù±‰∫¨ÈßÖ')}&destination=${dest.lat},${dest.lng}&travelmode=driving`;
            const gmapTransit = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent('Êù±‰∫¨ÈßÖ')}&destination=${dest.lat},${dest.lng}&travelmode=transit`;
            routeLinks.innerHTML = `
    <a class="btn-mini" target="_blank" rel="noreferrer" href="${gmapDrive}">üöó Google„Éû„ÉÉ„ÉóÔºàËªäÔºâ</a>
    <a class="btn-mini" target="_blank" rel="noreferrer" href="${gmapTransit}">üöÜ Google„Éû„ÉÉ„ÉóÔºàÈõªËªäÔºâ</a>
  `;

            document.getElementById('hotelLinks').innerHTML = `
    <a class="btn-mini" target="_blank" rel="noreferrer" href="${rakuten}">üß≥ Rakuten TravelÔºà${escapeHtml(words)}Ôºâ</a>
    <a class="btn-mini" target="_blank" rel="noreferrer" href="${airbnb}">üè° AirbnbÔºà${escapeHtml(words)}Ôºâ</a>
  `;

            // „Ç®„É™„Ç¢ÊÉÖÂ†±
            const ward = a.city_district || a.ward || '';
            document.getElementById('areaInfo').innerHTML = `
    <div>üóæ ÈÉΩÈÅìÂ∫úÁúå: ${escapeHtml(state || '(‰∏çÊòé)')}</div>
    <div>üèô Â∏ÇÂå∫Áî∫Êùë: ${escapeHtml(city || '(‰∏çÊòé)')}${ward ? 'Ôºà' + escapeHtml(ward) + 'Ôºâ' : ''}</div>
    <div>üìç Â∫ßÊ®ô: ${dest.lat.toFixed(5)}, ${dest.lng.toFixed(5)}</div>
  `;

            /* Â§©Ê∞ó„ÉªSNS„ÅÆ„Åø */
            setupWeather(dest.lat, dest.lng);
            setupSNS(state, city);

            detailEl.classList.add('show');
        });
        document.getElementById('detailClose').addEventListener('click', () => detailEl.classList.remove('show'));
        detailEl.addEventListener('click', (e) => { if (e.target === detailEl) detailEl.classList.remove('show'); });

        /* ========= Â§©Ê∞óÔºöOpen‚ÄëMeteoÔºàÁµµÊñáÂ≠óËøΩÂä†„Éª„Éì„Ç∏„É•„Ç¢„É´ÊîπÂñÑÔºâ ========= */
        const WCODE = {
            0: ['Âø´Êô¥', '‚òÄÔ∏è'], 1: ['Êô¥„Çå', '‚òÄÔ∏è'], 2: ['ËñÑÊõá„Çä', '‚õÖÔ∏è'], 3: ['Êõá„Çä', '‚òÅÔ∏è'],
            45: ['Èúß', '‚òÅÔ∏è'], 48: ['ÁùÄÊ∞∑ÊÄßÈúß', '‚òÅÔ∏è'],
            51: ['ÈúßÈõ®(Âº±)', '‚òî'], 53: ['ÈúßÈõ®(‰∏≠)', '‚òî'], 55: ['ÈúßÈõ®(Âº∑)', '‚òî'],
            61: ['Èõ®(Âº±)', '‚òî'], 63: ['Èõ®(‰∏≠)', '‚òî'], 65: ['Èõ®(Âº∑)', '‚òî'],
            66: ['ÂáçÈõ®(Âº±)', '‚òî'], 67: ['ÂáçÈõ®(Âº∑)', '‚òî'],
            71: ['Èõ™(Âº±)', '‚õÑ'], 73: ['Èõ™(‰∏≠)', '‚õÑ'], 75: ['Èõ™(Âº∑)', '‚õÑ'],
            77: ['Èõ™Áâá', '‚õÑ'],
            80: ['„Å´„Çè„ÅãÈõ®(Âº±)', '‚õÑ'], 81: ['„Å´„Çè„ÅãÈõ®(‰∏≠)', '‚õÑ'], 82: ['„Å´„Çè„ÅãÈõ®(Âº∑)', '‚õÑ'],
            85: ['„Å´„Çè„ÅãÈõ™(Âº±)', '‚õÑ'], 86: ['„Å´„Çè„ÅãÈõ™(Âº∑)', '‚õÑ'],
            95: ['Èõ∑Èõ®(Âº±„Äú‰∏≠)', '‚ö°'], 96: ['Èõ∑Èõ®(Èõπ„ÅÇ„ÇäÂº±)', '‚ö°'], 99: ['Èõ∑Èõ®(Èõπ„ÅÇ„ÇäÂº∑)', '‚ö°']
        };
        function wxEmoji(code) { return (WCODE[code] && WCODE[code][1]) || 'üó∫'; }
        function wxText(code) { return (WCODE[code] && WCODE[code][0]) || `Â§©Ê∞ó„Ç≥„Éº„Éâ${code}`; }
        function ymdToJa(iso) { try { const d = new Date(iso); return `${d.getMonth() + 1}/${d.getDate()}(${['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'][d.getDay()]})`; } catch { return iso; } }

        async function setupWeather(lat, lng) {
            const nowEl = document.getElementById('weatherNow');
            const dailyEl = document.getElementById('weatherDaily');
            nowEl.textContent = 'ÂèñÂæó‰∏≠‚Ä¶'; dailyEl.textContent = '';

            try {
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_sum&timezone=Asia%2FTokyo`;
                const res = await fetch(url);
                if (!res.ok) { nowEl.textContent = 'ÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü'; return; }
                const data = await res.json();
                const cw = data.current_weather || {};
                const code = cw.weathercode;
                const emoji = wxEmoji(code);
                const text = wxText(code);
                nowEl.innerHTML = `<span class="wx-emoji">${emoji}</span><span>ÁèæÂú®: ${cw.temperature != null ? `${Math.round(cw.temperature)}¬∞C` : '‚Äî'}„Éª${text}</span>`;

                const d = data.daily || {};
                const n = Math.min(3, (d.time || []).length);
                let html = '';
                for (let i = 0; i < n; i++) {
                    const date = d.time[i];
                    const tmax = d.temperature_2m_max?.[i];
                    const tmin = d.temperature_2m_min?.[i];
                    const pr = d.precipitation_sum?.[i];
                    const e = wxEmoji(d.weathercode?.[i]);
                    const label = wxText(d.weathercode?.[i]);
                    html += `
        <div class="wx-card">
          <div class="wx-emoji">${e}</div>
          <div>
            <div class="wx-date">${ymdToJa(date)}</div>
            <div class="wx-temp">${Math.round(tmin)}¬∞ / ${Math.round(tmax)}¬∞„ÉªÈôçÊ∞¥ ${Math.round(pr)}mm „Éª ${label}</div>
          </div>
        </div>`;
                }
                dailyEl.innerHTML = html || '‚Äî';
            } catch (e) {
                nowEl.textContent = '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº';
            }
        }

        /* ========= SNSÔºöInstagram „Éè„ÉÉ„Ç∑„É•„Çø„Ç∞ ========= */
        function hashtagLinks(state, city) {
            const base = (state || '').replace(/\s+/g, '');
            const muni = (city || '').replace(/\s+/g, '');
            const tags = [];
            if (muni) { tags.push(`${muni}Ë¶≥ÂÖâ`, `${muni}„Ç∞„É´„É°`, `${muni}ÊóÖË°å`); }
            if (base) { tags.push(`${base}Ë¶≥ÂÖâ`, `${base}„Ç∞„É´„É°`); }
            return Array.from(new Set(tags)).map(t => ({
                tag: t,
                url: `https://www.instagram.com/explore/tags/${encodeURIComponent(t)}/`
            }));
        }
        function setupSNS(state, city) {
            const box = document.getElementById('snsLinks');
            const tags = hashtagLinks(state, city);
            if (!tags.length) { box.innerHTML = '<span style="font-size:13px; opacity:.75">Ë©≤ÂΩì„Éè„ÉÉ„Ç∑„É•„Çø„Ç∞„Çí‰ΩúÊàê„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü</span>'; return; }
            box.innerHTML = tags.map(t => `<a class="btn-mini" target="_blank" rel="noreferrer" href="${t.url}">#${escapeHtml(t.tag)}</a>`).join('');
        }

        /* ========= „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ ========= */
        function pause(ms) { return new Promise(res => setTimeout(res, ms)); }
        function flyToCenter(latlng, zoom, ms) { return new Promise(res => { map.flyTo(latlng, zoom, { duration: ms / 1000, animate: true, easeLinearity: 0.2, noMoveStart: false }); setTimeout(res, ms); }); }
        function flyBounds(bounds, ms) { return new Promise(res => { map.flyToBounds(bounds, { padding: [40, 40], maxZoom: 11, animate: true, duration: ms / 1000, easeLinearity: 0.2 }); setTimeout(res, ms); }); }
        function disableInteractions(disable) { const fn = disable ? 'disable' : 'enable'; map.scrollWheelZoom[fn](); map.dragging[fn](); map.doubleClickZoom[fn](); map.boxZoom[fn](); map.keyboard[fn](); }
        function shake(el) { el.animate([{ transform: 'translateX(0)' }, { transform: 'translateX(-6px)' }, { transform: 'translateX(6px)' }, { transform: 'translateX(-3px)' }, { transform: 'translateX(3px)' }, { transform: 'translateX(0)' }], { duration: 320, iterations: 1, easing: 'ease-in-out' }); }
    </script>
</body>

</html>
